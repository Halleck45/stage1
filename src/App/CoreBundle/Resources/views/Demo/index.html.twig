{% extends '::demo.html.twig' %}

{% block javascripts %}
<script type="text/javascript">
$('form#form-build').on('submit', function(event) {
    event.preventDefault();
    event.stopPropagation();

    try {
        var url = $(this).attr('action');
        var data = { 'project_id': $('#project_id option:selected').attr('value') };

        $(this).find('button').html('<i class="icon-refresh icon-spin"></i>').attr('disabled', true);

        var form = this;

        $.post(url, data, function(data) {
            data = JSON.parse(data);

            var content = Mustache.render($('#tpl-steps').text(), { 'steps': data.steps });
            $('#build-steps').html(content);

            var content = Mustache.render($('#tpl-meta').text(), { 'project': data.project.name });
            $('#build-meta').html(content);

            $(form).hide();

            demo_websocket_listen(data.websocket_channel, data.websocket_token, data.build.id);
        });
    } catch (e) {
        console.dir(e);
    }
});
</script>
{% endblock javascripts %}

{% block body %}
<form id="form-build" class="form-inline" method="post" action="{{ path('app_core_demo_build') }}">
    <select name="project_id" id="project_id">
        {% for project in projects %}
        <option value="{{ project.id }}">{{ project.name }}</option>
        {% endfor %}
    </select>

    <button class="btn btn-primary" id="launch-build">build</button>
</form>

<div id="build-meta">
</div>

<div id="build-steps">
</div>

<script type="text/mustache" id="tpl-meta">{% verbatim %}
<h2>Building project {{project}}</h2>
{% endverbatim %}</script>

<script type="text/mustache" id="tpl-steps">{% verbatim %}
<ul id="steps">
    {{#steps}}
    <li class="pending" id="{{ id }}"><div class="icon-container"><i></i></div> {{ label }}</li>
    {{/steps}}
</ul>
{% endverbatim %}</script>

{% endblock body %}