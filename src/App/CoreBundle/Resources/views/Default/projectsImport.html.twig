{% extends '::base.html.twig' %}

{% block javascripts %}
<script type="text/javascript">
var github_access_token = '{{ access_token }}';
var github_api_base_url = '{{ github_api_base_url }}';
var import_url = '{{ path('app_core_project_import') }}';
var existing_projects = {{ existing_projects | json_encode | raw }};
find_repositories();

$('#projects-import-filter').on('keyup', function() {
    var term = $(this).val();

    console.log('filtering on "' + term + '"');

    $('[data-full-name]').each(function(i, el) {
        var fullName = $(el).data('full-name');
        var re = new RegExp('(' + term.toLowerCase() + ')', 'i');
        if (term === '' || null !== fullName.match(re)) {
            var ctnName = $(el).find('.ctn-name strong');
            ctnName.html(term === '' ? fullName : fullName.replace(re, '<em>$1</em>'));
            $(el).attr('data-filtered', 'no');
            $(el).show();
            $(el).parents('fieldset').show();
        } else {
            $(el).attr('data-filtered', 'yes');
            $(el).hide();
        }

        if ($(el).parents('fieldset').find('[data-filtered=no]').length === 0) {
            $(el).parents('fieldset').hide();
        }
    });
});
</script>
{% endblock javascripts %}

{% block body %}
<div id="projects_import_status" class="alert alert-info">
    <i class="fa fa-refresh fa-spin"></i>
    <span>Inspecting your github projects...</span>
</div>

<div class="row-fluid">
    <div class="span5" id="organisations">
        <input type="text" id="projects-import-filter" placeholder="Filter projects..." />
    </div>
    <div class="span6" id="progress">
    </div>
</div>

<script type="text/mustache" id="tpl-import">
{% verbatim %}
<p class="lead">Importing <strong>{{ full_name }}</strong></p>

<ul id="steps">
    {{#steps}}
    <li class="pending" id="{{ id }}"><div class="icon-container"><i></i></div> {{ label }}</li>
    {{/steps}}
</ul>

<div id="project-import-footer"></div>
{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-organisation">
{% verbatim %}
<fieldset id="org-{{ name }}">
    <p class="lead"><img class="candidates-organisation-avatar" height="20" width="20" src="{{ avatar_url }}" /> {{ name }}</p>

    <table class="table-candidates table">
        <thead>
            <tr>
                <th width="50%">&nbsp;</th>
            </tr>
        </thead>
        <tbody id="org-{{ name }}-candidates">
        </tbody>
    </table>
</fieldset>
{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project-button">
{% verbatim %}<a href="{{ url }}" class="btn btn-large btn-success">Visit project</a>{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project-link">
{% verbatim %}<a href="{{ url }}">{{ name }}</a>{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project-nav">
{% verbatim %}<li>{{{ link }}}</li>{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project">
{% verbatim %}
<tr class="candidate" id="candidate-{{ github_id }}" data-full-name="{{ name }}" data-filtered="no">
    <td class="ctn-name"><strong>{{ name }}</strong></td>
    <td class="ctn-button">
        <button class="btn btn-import">import</button>
        {{#data}}
        <input type="hidden" name="{{ name }}" value="{{ value }}" />
        {{/data}}
    </td>
</tr>
{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project-joinable">
{% verbatim %}
<tr class="candidate" id="candidate-{{ github_id }}" data-full-name="{{ name }}" data-filtered="no">
    <td class="ctn-name">
        <strong>{{ name }}</strong>
        <div class="help">users: {{ users }}</div>
    </td>
    <td class="ctn-button">
        <button class="btn btn-join" data-join-url="{{ join_url }}">join</button>
    </td>
</tr>
{% endverbatim %}
</script>

<script type="text/mustache" id="tpl-project-existing">
{% verbatim %}
<tr class="candidate" id="candidate-{{ github_id }}" data-full-name="{{ name }}" data-filtered="no">
    <td class="ctn-name">
        <strong>{{ name }}</strong>
        <div class="help">users: {{ users }}</div>
    </td>
    <td class="ctn-button">
        
    </td>
</tr>
{% endverbatim %}
</script>

{% endblock body %}