{% extends '::base.html.twig' %}

{% block javascripts %}
<script type="text/javascript">
$('#output').html(ansi_up.ansi_to_html($('#output').text()));
primus.on('data', function(data) {

    var container = $('pre#logs');
    
    if (data.event == 'build.log') {
        var build_id = parseInt(data.channel.match(/^build\.(\d+)$/)[1]);

        console.log(current_build_id, build_id);

        if (build_id !== current_build_id) {
            return;
        }

        container.append(data.content);
        container[0].scrollTop = container[0].scrollHeight;
    }
});
{% if build.building %}
stream_build_output($('#output'));
{% endif %}
</script>
{% endblock javascripts %}

{% block body %}
{% include 'AppCoreBundle:Default:_project_header.html.twig' with { project: build.project } %}

<fieldset id="build-metadata">
    <ul class="lead breadcrumb">
        <li>{{ build.ref }}{% if build.hash %} <span class="divider">/</span>{% endif %}</li>
        {% if build.hash %}
        <li><abbr title="{{ build.hash }}"><tt>{{ build.hash[0:8] }}</tt></abbr></li>
        {% endif %}
        <li id="build-{{ build.id }}-link" data-template="{{ '<span class="divider">/</span> <a href="{{ build_url }}">{{ build_url }}</a>' | e }}">
            {% if build.running and build.url %}
            <span class="divider">/</span>
            <a href="{{ build.url }}">{{ build.url }}</a>
            {% endif %}
        </li>

    </ul>
    <div class="row-fluid">
        <dl class="span4">
            <dt>Status</dt>
            <dd><span data-status="{{ build.status }}" id="build-{{ build.id }}-status" class="label label-{{ build.statusLabelClass }}">{{ build.statusLabel }}</span></dd>
            <dt>Created</dt>
            <dd><abbr class="timeago" title="{{ build.createdAt | date('c') }}">{{ build.createdAt | date('Y-m-d H:i:s') }}</abbr></dd>
        </dl>

        <dl class="span4">
            <dt>Ref.</dt>
            <dd>{{ build.ref }}</dd>
            <dt>Hash</dt>
            <dd>{% if build.hash %}<abbr title="{{ build.hash }}"><tt>{{ build.hash[0:8] }}</tt></abbr>{% else %}<abbr title="Not available">N/A</abbr>{% endif %}</dd>
        </dl>

        <dl class="span4">
            <dt>Initiator</dt>
            <dd>{% if build.initiator %}{{ build.initiator.username }}{% else %}<abbr title="Not available">N/A</abbr>{% endif %}</dd>
            {% if build.exitCode %}
            <dt>Exit code</dt>
            <dd><abbr title="{{ build.exitCodeText }}">{{ build.exitCode }}</abbr></dd>
            {% endif %}
        </dl>
    </div>
</fieldset>

<ul class="nav nav-pills" id="output-logs-menu">
    <li class="active"><a data-toggle="pill" href="#build-output">Build output</a></li>
    <li><a data-toggle="pill" href="#build-logs">Application logs</a></li>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane" id="build-logs">
        <div id="logs-container">
            <pre id="logs"></pre>
        </div>
    </div>

    <div class="tab-pane active" id="build-output">
        {% if build.building or build.output %}
        <div id="output-container">
            {% if build.building %}
            <div id="build-{{ build.id }}-progress" class="build-building-icon">
                <i class="icon-refresh icon-spin icon-4x"></i>
            </div>
            {% endif %}
        <pre id="output">{% spaceless %}
            {% if build.output %}
                {{ build.output | raw }}
            {% endif %}
        {% endspaceless %}</pre>
        </div>
        {% else %}
        <p class="lead">This build has no output.</p>
        {% endif %}
    </div>
</div>
{% endblock body %}