{% extends '::base.html.twig' %}

{% block javascripts %}
<script type="text/javascript">
{% if build.building %}
stream_build_output($('#output'));
{% else %}
    {% if forceTab == 'output' and streamLogs %}
    Scroller($('#output')[0], build_logs_load_url.replace(/0/, {{ build.id }})).init();
    {% else %}
    stream_build_logs($('#logs'));
    {% endif %}
{% endif %}
</script>
{% endblock javascripts %}

{% block body %}
{% include 'AppCoreBundle:Default:_project_header.html.twig' with { project: build.project } %}

<fieldset id="build-metadata">
    <ul class="lead breadcrumb">
        <li><a href="{{ path('app_core_build_show', { id: build.id }) }}">#{{ build.id }}</a> <span class="divider">/</span></li>
        <li>{{ build.ref }}</li>
        <li id="build-{{ build.id }}-link" data-template="{{ '<span class="divider">/</span> <a href="{{ build_url }}">{{ build_url }}</a>' | e }}">
            {% if build.running and build.url %}
            <span class="divider">/</span>
            <a href="{{ build.url }}">{{ build.url }}</a>
            {% endif %}
        </li>
    </ul>
    <div class="row-fluid">
        <dl class="span4">
            <dt>Status</dt>
            <dd><span data-status="{{ build.status }}" id="build-{{ build.id }}-status" class="label label-{{ build.statusLabelClass }}">{{ build.statusLabel }}</span></dd>
        </dl>

        <dl class="span4">
            <dt>Created</dt>
            <dd><abbr class="timeago" title="{{ build.createdAt | date('c') }}">{{ build.createdAt | date('Y-m-d H:i:s') }}</abbr></dd>
        </dl>

        <dl class="span4">
            <dt>Ref.</dt>
            <dd>
                {{ build.ref }}

                {% if build.hash %}
                (<a href="https://github.com/{{ build.project.githubFullName }}/commit/{{ build.hash }}">
                    <abbr title="{{ build.hash }}">{{ build.hash[0:8] }}</abbr>&nbsp;
                    <i class="icon-github"></i>
                </a>)
                {% endif %}
            </dd>
        </dl>
    </div>
</fieldset>

<ul class="nav nav-pills">
    <li{% if forceTab == 'output' %} class="active"{% endif %}>
        <a href="{{ path('app_core_build_output', { id: build.id }) }}">Build output</a>
    </li>
    <li{% if forceTab == 'logs' %} class="active"{% endif %}>
        <a href="{{ path('app_core_build_logs', { id: build.id }) }}">Application logs</a>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane{% if forceTab == 'output' %} active{% endif %}" id="build-output">
        {% if streamLogs %}
        <div id="output-container">
            {% if build.building %}
            <div id="build-{{ build.id }}-progress" class="build-building-icon">
                <i class="icon-refresh icon-spin icon-4x"></i>
            </div>
            {% endif %}
            <div id="logs-loading-indicator">
                <i class="icon-refresh icon-spin icon-4x"></i>
            </div>
            <pre id="output"></pre>
        </div>
        {% else %}
        <p class="lead">This build has too much log and we cannot stream them efficiently.</p>

        {% set download_url = path('app_core_build_logs_download', { id: build.id }) %}
        <p>Fortunately, you can still <a href="{{ download_url }}">download the logs</a> (or <a href="{{ download_url }}?gzip=1">gzipped</a>).</p>
        {% endif %}
    </div>

    <div class="tab-pane{% if forceTab == 'logs' %} active{% endif %}" id="build-logs">
        <div id="logs-container">
            <pre id="logs">{{ build.applicationLogs | join('\n') }}</pre>
        </div>
    </div>
</div>
{% endblock body %}