#!/bin/bash -eu

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source $DIR/../../../stage1.bash

stage1_exec cp /etc/symfony/parameters.yml.dist app/config/parameters.yml

stage1_announce "installing dependencies through composer"
stage1_exec composer install --ansi --no-progress --no-dev --prefer-dist --no-interaction

if app/console list doctrine:database > /dev/null 2>&1; then
    stage1_announce "initializing database"
    stage1_exec app/console doctrine:database:create
    stage1_exec app/console doctrine:schema:update --force
fi

if app/console list doctrine:fixtures > /dev/null 2>&1; then
    stage1_announce "loading fixtures"
    stage1_exec app/console doctrine:fixtures:load
fi

# @todo move to a $builder/bin/after script?
stage1_exec chmod -R 777 app/cache app/logs