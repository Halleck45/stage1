
'use strict';

module.exports = function(hipache, req, stack, next) {
    var project = req.headers.host.split(/\./)[1];
    var ip = req.connection.remoteAddress

    var auth_url = hipache.cache.config.server.config.auth_url;

    console.log('project: ' + project);
    console.log('ip: ' + ip);

    if (undefined === project) {
        console.log('no project detected, moving on');
        return next(); // next module
    }

    var auth_key = 'auth:' + project;
    var redis = hipache.cache.redisClient;

    console.log('checking auth for ' + project);

    redis.EXISTS(auth_key, function(err, exists) {
        if (err) {
            throw err;
        }

        if (exists) {
            console.log('project has auth activated, pushing middleware');
            stack.push(function(req, res, next) {
                redis.SISMEMBER(auth_key, ip, function(err, is_member) {
                    if (!is_member) {
                        console.log('sorry bobby, not this time')
                        // @todo there HAS to be a better http status than that
                        // @todo also, browser tend to cache 301, which we might not want
                        res.writeHead(301, {
                            'Location': auth_url.replace(/{slug}/, project) + '?return=' + encodeURIComponent(req.headers.host)
                        });
                        res.end();
                    } else {
                        next(); // next middleware
                    }

                });
            });
        } else {
            console.log('project does not have auth activated');
        }


        return next(); // next module
    });
}